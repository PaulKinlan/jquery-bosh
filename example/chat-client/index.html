<html>
<head>
<script src="../../jquery-1.2.6.js"></script>
<script src="../../jquery.base64.js"></script>
<script src="../../jquery.bosh.js"></script>
<link href="styles.css" media="screen" rel="stylesheet" type="text/css" />
<script>
var host = 'http://localhost/http-bind';
var session = null;

$(document).ready(function() {
  $('#login-button').bind('click', login);
  $('#logout-button').bind('click', logout);
  $('#roster-add').bind('click', subscribe);
  // $('#roster-delete').bind('click', unsubscribe);
});

function login() {
  session = new Session(host, $('#username').val(), $('#password').val());
  session.callbacks().login.success = loginSucceeded;
  session.callbacks().login.failure = loginFailed;
  session.callbacks().subscription.request = subscriptionRequest;
  session.callbacks().subscription.confirmation = subscriptionConfirmation;
  session.callbacks().roster.updated = updateRoster;
  session.callbacks().message.received = messageReceived;
  session.open();
}

function clearLoginForm() {
  $('#login input[type!="button"]').each(function(k, v) { v.value = '' });
}

function loginSucceeded() {
  clearLoginForm();
  $('#login').hide();
  updateRoster();
}

function loginFailed() {
  alert('Login failed: ' + session.error().message);
  clearLoginForm();
  $('#login input:first').focus();  
}

function logout() {
  session.close();
  $('#roster').hide();
  $('.chat-window').hide();
  $('#login').show();
  $('#login input:first').focus();
}

function subscribe() {
  var user = prompt('Type name of the user to add');
  user = $.trim(user);
  if (user) session.requestSubscription(user);
}

function subscriptionRequest( requests ) {
  $(session.queues().subscription.requests).each(function(k, v) {
    var confirmed = confirm(v.from.name + ' wants to add you as a friend. Approve?');
    if (confirmed) {
      session.approveSubscription(v.from.jid)
      session.requestSubscription(v.from.jid)
    }
  });
}

function subscriptionConfirmation() {
  var confirmed = '';
  $(session.queues().subscription.confirmations).each(function(k, v) {
    confirmed += v.name + '\n';
  });

  if (session.queues().subscription.confirmations.length > 1)
    alert('Your friend requests to the following users was approved: \n' + confirmed);
  else
    alert('Your friend request to ' + session.queues().subscription.confirmations[0].from.name + ' was approved');
}

function updateRoster() {
  if (!session.connected()) return;

  // Clear roster
  $('#roster #list ul').empty();

  // Add buddies to roster
  $(session.roster()).each(function(k, v) {
    var html;
    if (v.available) 
      html = tagBuilder('li', { jid: v.from.jid }, tagBuilder('a', { class: 'available', href: '#' }, v.from.name));
    else 
      html = tagBuilder('li', { jid: v.from.jid }, tagBuilder('a', { class: 'unavailable', href: '#' }, v.from.name));
    $('#roster #list ul').append(html);
  });

  // Control how a name looks when single-clicked on
  $('#roster #list ul > li').click(function() {
    deHighlight();
    $(this).css({ backgroundColor: 'blue' });
    $(this).children('a').css({ color: 'white' });
    $(this).children('a').blur();
  });
  
  // Open a new chat window when a name is double-clicked on
  $('#roster #list ul > li').dblclick(function() {
    deHighlight();
    var jid = $(this).attr('jid');
    createNewChatWindow(jid);
  });

  $('#roster').show();
};

function deHighlight() {
  $('#roster #list ul > li').css({ backgroundColor: 'white' });
  $('#roster #list ul > li a').css({ color: 'black' });
}

function createNewChatWindow( jid ) {
  var chatWindowId = domizeJid(jid)
  $('#template.chat-window').attr('id', chatWindowId).clone();
  $('#' + chatWindowId).show().children('textarea').focus();
  
  // Attach event to 'Send' button on chat window
  $('#' + chatWindowId + ' div.send input').bind('click', function() {
    var message = $.trim($(this).parents('.chat-window').children('textarea:first').val());
    var recipient = $(this).parents('.chat-window').attr('id').split('-')[0];
    $(this).parents('.chat-window').children('.outgoing:first')[0].value = "";
    addText($(this), { to: session.username(), message: message });
    session.sendMessage(recipient, message);
  });
}

function domizeJid( jid ) {
  return jid.split('@').join('-');
}

function messageReceived() {
  $(session.queues().messages).each(function(k, v) {
    var chatWindow = domizeJid(v.from.jid);
    if ($('#' + chatWindow).length == 0) createNewChatWindow(v.from.jid);
    addText($('#' + chatWindow), { from: v.from.name, message: v.message });
  });
}

function addText( jqElement, settings ) {
  if (settings['to'] == null)
    html = '<p class="message"><span class="from">' + settings['from'] + ':</span> ';
  else
    html = '<p class="message"><span class="to">' + settings['to'] + ':</span> ';
  html += settings['message'] + '</p>';
  element = jqElement.hasClass('chat-window') ? jqElement.children('.incoming') : jqElement.parents('.chat-window').children('.incoming');
  element.append(html);
}
</script>
</head>
<body>
<div id="container">

	<div class="chat-window" id="template">
    <div class="header"></div>
    <div class="incoming"></div>
    <textarea class="outgoing"></textarea>
    <div class="send"><input type="button" value="Send" name="send"></div>
	</div>

  <div id="roster">
    <div class="header">Roster</div>
    <div id="list"><ul></ul></div>
    <p>
      <input type="button" value="Add" id="roster-add">
      <input type="button" value="Delete" id="roster-delete">
    <p>
    <p>
      <input type="button" value="Logout" id="logout-button">
    </p>
  </div>

  <div id="login">
    <div class="field">
      Login<input type="text" name="username" id="username">
    </div>
    <div class="field">
      Password<input type="password" name="password" id="password">
    </div>
    <input type="button" value="Login" id="login-button">
  </div>

</div>
</body>
</html>
